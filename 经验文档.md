# 项目部署经验总结

本文档记录了在部署 Docker + Nginx + Cloudflare Tunnel 过程中的主要挑战和解决方案，以供未来参考。

## 目标

在本地设备上运行一个 Docker 化的 embedding 模型，并通过 Cloudflare Tunnel 将其安全地发布到公网，使用自定义域名访问。

---

### 挫折 1：Docker 镜像无法拉取

- **问题**：`docker pull` 命令失败，提示 `manifest not found`。
- **初步诊断**：镜像名称错误，或者是需要登录的私有镜像。
- **解决方案**：用户确认是私有镜像，但在我们尝试 `docker login` 之前，用户选择将镜像权限设为公开，随后 `docker pull` 成功。

### 挫折 2：服务启动后连接被重置

- **问题**：`curl` 访问本地端口 `8000` 时，连接被重置。
- **诊断**：通过 `docker logs` 查看容器日志，发现模型正在从网络上下载，服务尚未完全就绪。
- **解决方案**：耐心等待几分钟，让模型完全加载到内存中。之后再次测试，服务正常响应。

### 挫折 3：Nginx 配置文件权限问题

- **问题**：我（AI Agent）没有权限直接写入系统目录 `/etc/nginx/`。
- **解决方案**：将 Nginx 配置文件先写入项目文件夹 (`/home/tom/embedding_project/`)，然后提供完整的 `sudo` 命令，由用户复制粘贴到自己的终端中执行，以完成文件的复制和链接。

### 挫折 4：Cloudflare Tunnel 路由复杂冲突 (核心问题)

这是一个多层次的复合问题：

1.  **冲突的 Nginx 站点**
    - **现象**：通过公网访问时，请求被一个处理 `badtom.xyz` 的默认 Nginx 配置捕获。
    - **诊断**：通过 `ls /etc/nginx/sites-enabled/` 发现除了我们的 `embedding_proxy` 外，还有一个 `badtom` 的站点配置。
    - **解决方案**：指导用户通过 `sudo rm /etc/nginx/sites-enabled/badtom` 暂时禁用了这个冲突的站点。

2.  **错误的 Cloudflare Zone 授权**
    - **现象**：`cloudflared tunnel route dns` 命令总是失败，并产生一个奇怪的混合域名 (`...badtom.xyz`)。
    - **诊断**：`cloudflared` 客户端被授权给了 `badtom.xyz` 这个根域名（Zone），而不是我们想要使用的 `badtom.dpdns.org`。
    - **解决方案**：指导用户删除旧的授权证书 (`rm ~/.cloudflared/cert.pem`)，然后重新运行 `cloudflared tunnel login`，并在浏览器弹出的页面上，从域名列表中**手动选择正确的 `badtom.dpdns.org`** 进行授权。

3.  **云端配置覆盖本地配置**
    - **现象**：即使我们修改了本地的 `config.yml`，`cloudflared` 启动时依然加载旧的、包含 `badtom.xyz` 的云端配置。
    - **诊断**：隧道的 `ingress` 规则被 Cloudflare 的 Zero Trust 仪表盘远程管理。
    - **解决方案**：放弃在本地修改 `config.yml` 的方式。指导用户登录 Cloudflare 仪表盘，找到 `Networks -> Tunnels`，选择对应的隧道，在 `Public Hostnames` 中**手动添加** `embedding.badtom.dpdns.org` 的路由规则，并将其指向正确的本地服务地址 `http://localhost:8000`。

4.  **UI 界面中的 DNS 冲突**
    - **现象**：用户在 UI 中添加 Public Hostname 时，提示子域名冲突。
    - **诊断**：之前失败的 `route dns` 命令可能在 DNS 设置中留下了一个不完整的、冲突的 `CNAME` 记录。
    - **解决方案**：指导用户先去 `DNS` 管理页面，手动查找并删除名为 `embedding` 的冲突记录，然后再回到 `Tunnels` 页面添加 Public Hostname。

### 最终成功

在解决了以上所有问题，特别是正确配置了 Cloudflare 云端的 Public Hostname 规则后，服务最终通过 `https://embedding.badtom.dpdns.org` 成功访问。
tom@tom-450R4J-450R4Q-451R4J-4450RJ:~$ cloudflared tunnel run 797a0370-c5c3-4c5a-be54-9330f2b2b882
